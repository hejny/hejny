#!/usr/bin/env ts-node

import chalk from 'chalk';
import commander from 'commander';
import { writeFile } from 'fs/promises';
import { join } from 'path';
import spaceTrim from 'spacetrim';
import { commit } from '../0-utils/commit';
import { findProjectsOnGithub } from './findProjectsOnGithub';
import { projectToMardown } from './projectToMardown';

main();

async function main() {
    console.info(chalk.bgBlue(`üè≠ Generate projects`));

    const program = new commander.Command();
    program.option('--commit', `Commit after generate`, false);

    program.parse(process.argv);
    const { commit: isCommit } = program.opts();

    // TODO: !!!projects Better semantics function findProjects creates organizations?!
    const organizations = await findProjectsOnGithub();

    // TODO: Remove date - but for now it is useful for testing Github action
    const projectsContent = spaceTrim(
        (block) => `

        <!--
        Note: See [ü¶ä] in root README for more information
        {% include index.html %}
        -->

        # üë®‚Äçüè≠ Projets

        <!-- ‚ö†Ô∏è WARNING: This was generated by generate-projects at ${new Date().toISOString()}-->
        All projects I have worked on:

        ${block(
            Object.values(organizations)
                .map(({ organizationTitle, projects }) =>
                    spaceTrim(
                        (block2) => `
                            ## ${organizationTitle}
                            
                            ${block2(
                                projects
                                    .map(projectToMardown)
                                    .map((projectMardown) => `-   ${projectMardown}`)
                                    .join('\n'),
                            )}
                        `,
                    ),
                )
                .join('\n\n'),
        )}
    
    `,
    );

    await writeFile(join(process.cwd(), 'documents/projects.md'), projectsContent, 'utf8');

    if (isCommit) {
        await commit({ projectPath: process.cwd(), message: `üè≠ Generate projects` });
    }

    process.exit(0);
}

/**
 * TODO: !!!projects All projects must have emoji icons
 * TODO: [ü•≥] Also include project from here https://docs.google.com/spreadsheets/d/1tGQBOknXYAnn9rDCE7KsbpyapVb6NKdwiONwPJl3DF0/edit?usp=sharing
 *       - TODO: !!!projects Maybe EVERY project should have a Github page?
 */
